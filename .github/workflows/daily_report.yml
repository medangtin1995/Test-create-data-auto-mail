name: Daily Automail Report

on:
  schedule:
    # 8:00 AM JST = 23:00 UTC (previous day)
    - cron: '0 23 * * *'
  workflow_dispatch:
    inputs:
      mode:
        description: 'Run mode: yesterday (default), date, month_to_date (1st to today), full_month'
        required: true
        type: choice
        options:
          - yesterday
          - date
          - month_to_date
          - full_month
        default: yesterday
      date:
        description: 'Specific date (YYYY-MM-DD) - only for "date" mode'
        required: false
        type: string
      year_month:
        description: 'Year and month (YYYY-MM) - only for "full_month" mode'
        required: false
        type: string
      dry_run:
        description: 'Dry run mode (preview without executing)'
        required: false
        type: boolean
        default: false

jobs:
  process-daily-report:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r measurement/requirements.txt
        
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ap-northeast-1
          
      - name: Setup Google credentials
        run: |
          echo "${{ secrets.GOOGLE_SERVICE_ACCOUNT }}" | base64 -d > measurement/service_account.json
        
      - name: Create .env file
        run: |
          echo "BUCKET_NAME=${{ secrets.BUCKET_NAME }}" >> measurement/.env
          echo "TABLE_NAME=${{ secrets.TABLE_NAME }}" >> measurement/.env
          echo "REGION=ap-northeast-1" >> measurement/.env
          echo "CONFIG_SHEET_ID=${{ secrets.CONFIG_SHEET_ID }}" >> measurement/.env
          
      - name: Run daily report
        working-directory: ./measurement
        run: |
          DRY_RUN_FLAG=""
          if [ "${{ inputs.dry_run }}" == "true" ]; then
            DRY_RUN_FLAG="--dry-run"
          fi
          
          MODE="${{ inputs.mode }}"
          if [ -z "$MODE" ]; then
            MODE="yesterday"
          fi
          
          case "$MODE" in
            yesterday)
              echo "Processing yesterday's data"
              python run_all_scripts.py --yesterday $DRY_RUN_FLAG
              ;;
            date)
              echo "Processing specific date: ${{ inputs.date }}"
              python run_all_scripts.py --date "${{ inputs.date }}" $DRY_RUN_FLAG
              ;;
            month_to_date)
              echo "Processing month to date"
              python run_all_scripts.py --month-to-date $DRY_RUN_FLAG
              ;;
            full_month)
              YEAR_MONTH="${{ inputs.year_month }}"
              YEAR=$(echo $YEAR_MONTH | cut -d'-' -f1)
              MONTH=$(echo $YEAR_MONTH | cut -d'-' -f2)
              echo "Processing full month: $YEAR-$MONTH"
              python run_all_scripts.py --year "$YEAR" --month "$MONTH" $DRY_RUN_FLAG
              ;;
          esac
          
      - name: Upload logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-logs
          path: |
            measurement/data/
            measurement/events/
            measurement/requests/
          retention-days: 7
